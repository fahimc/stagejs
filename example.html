<html>
  <head>
    <style></style>
  </head>
  <body>
    <canvas></canvas>
    <script>
      class CanvasElement {
        constructor(ctx, stage) {
          this.ctx = ctx;
          this.stage = stage;
          this._textContent = "";
          this._style = {
            left: 0,
            top: 0,
            width: 100,
            height: 100,
            borderWidth: 1,
            borderStyle: "solid",
            borderColor: "#000",
            paddingLeft: 0,
            paddingRight: 0,
            paddingTop: 0,
            paddingBottom: 0,
          };
          this.parentNode = undefined;
        }
        set style(value) {
          this._style = { ...this._style, ...value };
          this.stage.update();
        }
        get style() {
          return this._style;
        }
        set textContent(value) {
          this._textContent = value;
          this.stage.update();
        }
        get textContent() {
          return this._textContent;
        }
        appendChild(element) {
          element.parentNode = this;
          this.stage.children.push(element);
          this.stage.update();
        }
        createTextElement() {
          this.ctx.font = "12px serif";
          let metrics = this.ctx.measureText(this.textContent);
          let height =
            metrics.actualBoundingBoxAscent + metrics.actualBoundingBoxDescent;
          this.ctx.fillText(
            this.textContent,
            this.getRelativeStyle("left") + this.style.paddingLeft,
            this.getRelativeStyle("top") + this.style.paddingTop + height
          );
        }
      }

      class CanvasDiv extends CanvasElement {
        render() {
          this.ctx.beginPath();
          const parentStyle = this.parentNode?.style || {
            left: 0,
            top: 0,
            width: 0,
            height: 0,
          };
          const elementStyle = this.style;
          this.ctx.rect(
            this.getRelativeStyle("left"),
            this.getRelativeStyle("top"),
            elementStyle.width,
            elementStyle.height
          );
          this.ctx.strokeStyle = this.style.borderColor;
          this.ctx.lineWidth = this.style.borderWidth;
          this.ctx.stroke();
          if (this.textContent) {
            this.createTextElement();
          }
        }

        getRelativeStyle(key) {
          return (this.parentNode?.style[key] || 0) + this.style[key];
        }
      }

      class Stage {
        constructor(canvas) {
          this.children = [];
          this.canvas = canvas;
          this.ctx = canvas.getContext("2d");
          this.body = new CanvasDiv(this.ctx, this);
        }
        createElement(tagName) {
          switch (tagName) {
            case "div":
              return new CanvasDiv(this.ctx, this);
              break;
          }
        }
        update() {
          this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
          this.children.forEach((item) => item.render());
        }
      }

      const canvas = document.querySelector("canvas");
      canvas.width = 500;
      const stage = new Stage(canvas);
      const container = stage.createElement("div");
      const div = stage.createElement("div");
      stage.body.appendChild(container);
      container.appendChild(div);
      div.style = {
        top: 20,
        left: 20,
        borderColor: "green",
      };
      div.textContent = "hello";
      setTimeout(() => {
        container.style = {
          top: 50,
          borderColor: "red",
        };
      }, 50);
    </script>
  </body>
</html>
